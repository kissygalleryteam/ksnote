/*!build time : 2013-10-22 1:48:47 PM*/
KISSY.add("kg/ksnote/2.0.0/index",function(a,b,c,d,e,f){function g(a,b){a&&void 0==i.get(a).nodeType&&(b=a,a=void 0),g.superclass.constructor.call(this,b),this._init.call(this,a)}var h=b.all,i=a.DOM,j=d.Draggable,k=new f,l='<div class="{prefixCls}note ks-note"><div class="{prefixCls}note-hd"><i class="{prefixCls}note-nail"></i><h4>{title}</h4></div><div class="{prefixCls}note-bd"><textarea class="{prefixCls}note-text" id="ksnote{id}">{text}</textarea><a href="javascript:void(0);" class="{prefixCls}note-hide" title="\u9690\u85cf"></a><a href="javascript:void(0);" class="{prefixCls}note-delete" title="\u5220\u9664"></a>{hasLink}</div></div>';return a.extend(g,c),g.ATTRS={prefixCls:{value:"ks-"},title:{value:""},isCrossDomain:{value:!1},domain:{},isShowOld:{value:!0}},a.augment(g,{_init:function(a){var b=this;this.trigger=a?h(a):h(document),b.getData(function(a){b._renderUI(a),b._bindEvent()})},_renderUI:function(b){var c,d=this,f=this.get("prefixCls");c=b?a.merge(b,{hasLink:b.link?'<a href="'+b.link+'" class="'+f+'note-link" target="_blank">go to look?</a>':""}):{prefixCls:d.get("prefixCls"),title:d.get("title")};var g=a.substitute(l,c);h(g).appendTo("body"),new j({move:!0,node:".ks-note",handlers:[".ks-note-hd"]}).plug(e).on("dragend",function(){d._getNode("text").val().length>0&&d.setData(d._getNode("text").val())})},_bindEvent:function(){var a,b=this._getNode("delete"),c=this._getNode("hide"),d=this._getNode("text");a=this.trigger[0]!=document?"click":"dblclick",this.trigger.on(a,this._triggerHandler,this),b.on("click",this._deleteHandler,this),c.on("click",this._hideHandler,this),this._valueChangeHandler(),d.on("valuechange",this.__vchandler,this)},_triggerHandler:function(){this.show()},_deleteHandler:function(){var a=this;a.removeData(function(){a.destroy()})},_hideHandler:function(){this.hide()},_valueChangeHandler:function(){var b=this;b.__vchandler=a.buffer(function(a){var c=a.currentTarget,d=c.value;b.setData(d)},500)},setData:function(b,c){var d=this,e=d._getNode(),f={title:d.get("title"),prefixCls:d.get("prefixCls"),text:b,link:document.location.href,postion:e.offset(),id:(new Date).getTime()},g="/"+document.domain;location.href.indexOf(g)>-1&&this.get("isCrossDomain")&&(g=this.get("domain")),k.set({k:"ksnote"+g,v:f,success:function(b){a.isFunction(c)&&c.call(this,b)}})},getData:function(b){var c=this,d="/"+document.domain;location.href.indexOf(d)>-1&&this.get("isCrossDomain")&&(d=this.get("domain")),k.get({k:"ksnote"+d,success:function(d){d&&!c.get("isShowOld")&&(d=void 0),a.isFunction(b)&&b.call(this,d)}})},removeData:function(b){var c="/"+document.domain;location.href.indexOf(c)>-1&&this.get("isCrossDomain")&&(c=this.get("domain")),k.remove({k:"ksnote"+c,success:function(c){a.isFunction(b)&&b.call(this,c)}})},show:function(){var a=this._getNode();this.getData(function(b){b?a.css({left:b.postion.left,top:b.postion.top,visibility:"visible"}):a.css("visibility","visible")})},hide:function(){var a=this._getNode();a.css("visibility","hidden")},destroy:function(a){var b=this._getNode("delete"),c=this._getNode("text"),d=this._getNode();clickType=this.trigger[0]==document?"click":"dblClick",this.trigger.detach(clickType,this._triggerHandler),b.detach("click",this._deleteHandler),c.detach("valuechange",this.__vchandler),d.remove(),a&&self.removeData()},_getNode:function(a){var b=a?"note-"+a:"note";return h("."+this.get("prefixCls")+b)}}),g},{requires:["node","base","dd","dd/plugin/proxy","kg/storage/2.0.0/index"]});